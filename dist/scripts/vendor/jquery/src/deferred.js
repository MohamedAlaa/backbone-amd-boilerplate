define(["./core","./var/slice","./callbacks"],function(e,t){return e.extend({Deferred:function(t){var n=[["resolve","done",e.Callbacks("once memory"),"resolved"],["reject","fail",e.Callbacks("once memory"),"rejected"],["notify","progress",e.Callbacks("memory")]],r="pending",i={state:function(){return r},always:function(){return s.done(arguments).fail(arguments),this},then:function(){var t=arguments;return e.Deferred(function(r){e.each(n,function(n,o){var u=e.isFunction(t[n])&&t[n];s[o[1]](function(){var t=u&&u.apply(this,arguments);t&&e.isFunction(t.promise)?t.promise().done(r.resolve).fail(r.reject).progress(r.notify):r[o[0]+"With"](this===i?r.promise():this,u?[t]:arguments)})}),t=null}).promise()},promise:function(t){return t!=null?e.extend(t,i):i}},s={};return i.pipe=i.then,e.each(n,function(e,t){var o=t[2],u=t[3];i[t[1]]=o.add,u&&o.add(function(){r=u},n[e^1][2].disable,n[2][2].lock),s[t[0]]=function(){return s[t[0]+"With"](this===s?i:this,arguments),this},s[t[0]+"With"]=o.fireWith}),i.promise(s),t&&t.call(s,s),s},when:function(n){var r=0,i=t.call(arguments),s=i.length,o=s!==1||n&&e.isFunction(n.promise)?s:0,u=o===1?n:e.Deferred(),a=function(e,n,r){return function(i){n[e]=this,r[e]=arguments.length>1?t.call(arguments):i,r===f?u.notifyWith(n,r):--o||u.resolveWith(n,r)}},f,l,c;if(s>1){f=new Array(s),l=new Array(s),c=new Array(s);for(;r<s;r++)i[r]&&e.isFunction(i[r].promise)?i[r].promise().done(a(r,c,i)).fail(u.reject).progress(a(r,l,f)):--o}return o||u.resolveWith(c,i),u.promise()}}),e});